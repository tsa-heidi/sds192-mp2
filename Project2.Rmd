---
title: "Project 2 : Data Wrangling"
author: Heidi, Harriet, Viola 
output: 
  html_document:
    cold_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#### Using a GitHub repository and including a link to it in the footnotes
We used Github Repository ^[https://github.com/tsa-heidi/sds192-mp2] 

```{r}
devtools::install_github("benmarwick/wordcountaddin", type = "source", dependencies = TRUE)
```


```{r}
wordcountaddin::word_count("Project2.Rmd")
```

```{r, message= FALSE}
# Loading datasets ----
load("house_elections.rda")
load("candidates.rda")
load("committees.rda")
load("contributions.rda")
```



```{r, message= FALSE, echo= FALSE}
# Loading libraries ----
library(tidyverse)
library(dplyr)
library(ggrepel)
library(RColorBrewer)
```

```{r, message= FALSE, eval=FALSE}
# Verification of the data ----
glimpse(house_elections)
glimpse(candidates)
glimpse(committees)
glimpse(contributions)
```

```{r,message= FALSE}
# Modifying the candidates data frame ----
candidates_NY2012 <- candidates %>%
  filter(cand_office_state == "NY")%>%
  filter(cand_party_affiliation == "DEM")%>%
  filter(cand_party_affiliation == "DEM") %>%
  filter(cand_election_yr == 2012) %>%
  select(cand_id, 
         cand_name)
```

```{r,message= FALSE}
# Creating a table of candidate IDs from the wrangled candidates data set ----
cand_IDs <- select(candidates_NY2012,
                   matches("cand_id"))
```

```{r,message= FALSE}
# Wrangling the contributions data frame ----
contributions_NY <- contributions %>% 
  filter(cand_id %in% cand_IDs$cand_id) %>%
  select(cand_id, 
         transaction_amt)
```

```{r,message= FALSE}
# Wrangling the house elections data frame ----
house_elections_NY2012 <- house_elections %>%
  select(fec_id, 
         ge_winner, 
         incumbent)
```

```{r,message= FALSE}
# Joining the wrangled contributions and candidates data frames using full_join ----
contr_cand_joined <- full_join(contributions_NY,
                               candidates_NY2012, 
                               by= "cand_id") %>%
  group_by(cand_id, 
           cand_name) %>%
  summarise(sum = sum(transaction_amt)) %>%
  arrange(sum)
```

```{r,message= FALSE}
# Wrangling house elections by filtering with candidates IDs in the joined candidate and contribution data frame ----
house_elections_NY2012 <- filter(house_elections_NY2012,
                                 fec_id %in% contr_cand_joined$cand_id) %>%
  mutate(cand_id = fec_id)
```

```{r,message= FALSE}
# Creating the final data frame by using inner join to join the wrangled house election and the previously joined data frame of candidates and contributions ----
final_df <- inner_join(contr_cand_joined,
                       house_elections_NY2012, 
                       by = "cand_id") %>%
  select(cand_name, 
         sum, 
         ge_winner, 
         incumbent) %>%
  arrange(sum) %>%
  filter(sum >= 40000) %>% # we chose to filter out candidates who received less than 50 000 dollars 
  filter(!is.na(sum))
```
#Creating the data graphic using the final data frame



```{r,message= FALSE}
options(scipen = 100000)
NYDplot <- ggplot(data = final_df, 
                   aes(x = reorder(cand_name,-sum), 
                       y = sum, fill = ge_winner)) + 
  geom_bar(position = "dodge",
           stat = "identity") +
  coord_flip() +
  ggtitle("Do Contributions Determine House-Election success?") +
  xlab("") +
  labs(fill="") +
  scale_fill_discrete(labels=c("Lost", "Won")) +
  scale_y_continuous(name = "Money Contributed (USD)",                breaks=c(0,2000000,4000000),
                     labels=c("0", 
                              "2,000,000",
                              "4,000,000")) + 
  theme(axis.text.x = element_text(angle = 0))
NYDplot
```

```{r}
incumbent <- c("Non incumbent", "Incumbent")
names(incumbent)<-c("FALSE","TRUE")
```

```{r}
# Faceting the final data graphic by incumbent ----
NYDplot2 <- ggplot(data = final_df, 
                   aes(x = reorder(cand_name,-sum),
                       y = sum, 
                       fill = ge_winner)) + 
  geom_bar(position = "dodge",
           stat = "identity")+
  coord_flip() +
  ggtitle("Do Contributions Determine House-Election success?") +
  xlab("") +
  labs(fill="") +
  scale_fill_discrete(labels = c("Lost","Won")) +
  scale_y_continuous(
    name = "Money Contributed (USD)",
    breaks=c(0,2000000,4000000),
    labels=c("0", "2,000,000", "4,000,000")) +
  facet_wrap(~incumbent,labeller = labeller(incumbent = incumbent))+
   theme_get()
```

# Functions

Creating a function to wrangle candidates data
```{r,message= FALSE}
# Function 1 generalizes the data wrangling for the candidates dataset ----
function1_candidates <- function(year, state,party) {
  candidates %>%
    filter(cand_election_yr == year) %>%
    filter(cand_party_affiliation == party) %>%
    filter(cand_office_state == state) %>%
    select(cand_id, cand_name) 
}
```

```{r,message= FALSE}
# Function 2 takes the data frame made by the 1st function and creates a list of the candidate IDs from that data frame ----
function2_candid_id <- function(function1df) {
  select(function1df, matches("cand_id"))
}
```

```{r,message= FALSE}
# Function 3 takes the data frame made from function 2 and uses it to wrangle the contributions data frame ----
function3_contributions <- function(function2df) {
  contributions %>%
    filter(cand_id %in%
             function2df$cand_id) %>%
    select(cand_id, transaction_amt)
}
```

```{r,message= FALSE}
# Function 4 takes the wrangled candidates data frame produced by function 1 and the wrangled contribution data frame produced by function 3 and joins those two dataframes ----
function4_joincand_cont <- function(function1df, function3df) {
  full_join(function1df, function3df, by="cand_id") %>%
    group_by(cand_id, cand_name) %>%
    summarise(sum=sum(transaction_amt)) %>%
    arrange(sum)
}
```

```{r,message= FALSE}
# Function 5 takes the data frame created by function 4, and uses it to wrangle the house elections data frame ----
function5_house_elec <- function(function4df) {
  house_elections %>% 
    select(fec_id, ge_winner, incumbent) %>%
    filter(fec_id %in% function4df$cand_id) %>%
    mutate(cand_id = fec_id)
}

```

```{r,message= FALSE}
# Function 6 takes the data frame created by function 4 and function 5 and joins them to create the final data frame that will produce the overall analysis

function6_finaldf <- function(function4df, function5df) {
  inner_join(function4df, function5df, by = "cand_id") %>%
    select(cand_name, sum, ge_winner, incumbent) %>%
    arrange(ge_winner) %>%
    filter(!is.na(sum)) %>%
    filter(sum > 50000)
}
```



```{r}
function7_plot <- function(function6df) {
	  ggplot(data = function6df, 
	                   aes(x = reorder(cand_name,-sum), 
	                       y = sum, 
	                       fill = ge_winner)) + 
	  geom_bar(position = "dodge",
	           stat = "identity") +
	                     coord_flip() +
  ggtitle("Do Contributions Determine House-Election success?") +
  xlab("") +
  labs(fill="") +
  scale_fill_discrete(labels=c("Lost", "Won")) +
  scale_y_continuous(name = "Money Contributed (USD)",                breaks=c(0,2000000,4000000),
                     labels=c("0", 
                              "2,000,000",
                              "4,000,000")) + 
  theme(axis.text.x = element_text(angle = 0))
}
```

```{r}
function8_facet <- function(function7plotname) {
  function7plotname + facet_wrap(~incumbent,labeller = labeller(incumbent = incumbent))+
   theme_get()
}
```

```{r,message= FALSE}
NYR <- function1_candidates(2012, "NY", "REP")
NYRcandid <- function2_candid_id(NYR)
NYRcontr <- function3_contributions(NYRcandid)
NYRjoined <- function4_joincand_cont(NYR, NYRcontr)
NYRhouse <- function5_house_elec(NYRjoined)
NYRfinal <- function6_finaldf(NYRjoined, NYRhouse)
NYRplot <- function7_plot(NYRfinal)
NYRplot2 <- function8_facet(NYRplot)
```

```{r}
CAD <- function1_candidates(2012, "CA", "DEM" )
CADcandid <- function2_candid_id(CAD)
CADcontr <- function3_contributions(CADcandid)
CADjoined <- function4_joincand_cont(CAD, CADcontr)
CADhouse <- function5_house_elec(CADjoined)
CADfinal <- function6_finaldf(CADjoined, CADhouse)
CADplot <- function7_plot(CADfinal)
CADplot2 <- function8_facet(CADplot)
```

```{r,message= FALSE}
	CAR <- function1_candidates(2012, "CA", "REP" )
	CARcandid <- function2_candid_id(CAR)
	CARcontr <- function3_contributions(CARcandid)
	CARjoined <- function4_joincand_cont(CAR, CARcontr)
	CARhouse <- function5_house_elec(CARjoined)
	CARfinal <- function6_finaldf(CARjoined, CARhouse)
	CARplot <- function7_plot(CARfinal)
	CARplot2 <- function8_facet(CARplot)
```

```{r,message= FALSE}
	TXD <- function1_candidates(2012, "TX", "DEM" )
	TXDcandid <- function2_candid_id(TXD)
	TXDcontr <- function3_contributions(TXDcandid)
	TXDjoined <- function4_joincand_cont(TXD, TXDcontr)
	TXDhouse <- function5_house_elec(TXDjoined)
	TXDfinal <- function6_finaldf(TXDjoined, TXDhouse)
	TXDplot <- function7_plot(TXDfinal)
	TXDplot2 <- function8_facet(TXDplot)
```


```{r,message= FALSE}
	TXR <- function1_candidates(2012, "TX", "REP" )
	TXRcandid <- function2_candid_id(TXR)
	TXRcontr <- function3_contributions(TXRcandid)
	TXRjoined <- function4_joincand_cont(TXR, TXRcontr)
	TXRhouse <- function5_house_elec(TXRjoined)
	TXRfinal <- function6_finaldf(TXRjoined, TXRhouse)
	TXRplot <- function7_plot(TXRfinal)
	TXRplot2 <- function8_facet(TXRplot)

```

#### New York 
```{r, message= FALSE}
# The plots ----
NYDplot  
NYDplot2
NYRplot
NYRplot2
```

### California
```{r,message= FALSE}
CADplot 
CADplot2
CARplot 
CARplot2 
```

### Texas
```{r,message= FALSE}
TXDplot 
TXDplot2
TXRplot 
TXRplot2 

```


Do the amount on contributions in house elections influence election success?
The questions our wrangled data attempts to address is whether the total amount of contributions received by candidates running in house elections is positively correlated with their chances of a win. We analyzed data in the year 2012 from three FEC data sets: Candidates, Contributions and House Elections. 

Context
The house of representatives is composed of representatives who represent their congressional districts in their respective states. The number of congressional districts allocated to each of the 50 states is based on the state’s population size. Each district is entitled to one representative. Thus, there are multiple candidates running for house elections within each party for a particular state. Our analysis focuses on these candidates running for election to the house of representatives. 

Method of investigation
Our investigation began by first focusing on candidates within a particular state, year and party. We included party as variable to control for the fact that the probability of winning may be influenced by whether a state is already blue or red from the last election cycle. 

We began with New York Democrats in 2012 and wrangled this from the FEC “Candidates” data set. We then created a list of the candidates’ IDs and used these IDs to filter out their corresponding contributions from the FEC “Contributions” data set. The two datasets, “Candidates” and “Contributions”, were then joined by their corresponding candidate IDs. 

In the House Elections dataset, we filtered for our variables of interest: candidate ID (under the name fec_id), whether the candidate won or lost, and whether they were an incumbent. We proceeded to filter the House Election dataset by the candidate IDs we wrangled earlier (New York Democrats in 2012). 

Our final data frame was created by joining the data sets; Contributions, Candidates and House Elections, by the selected candidate IDs. We calculated the total amount of contributions each candidate received and removed candidates with no data. Since previous research has found that on average house candidates received approximately 1.6 million dollars in campaign contributions, we filtered out candidates who received less than $50000. This gives us a diversity of candidates yet eliminates any data that may not be useful in our analysis.

Considering that our sample size becomes too small to pick up any trend once filtering out for year, party and state, we created functions to generalize our analysis and ran them for the three biggest states, by population, in each region: New York (East), California (West) and Texas (South). 

Results
Upon analyzing our graphs that do not take into account whether a candidate is an incumbent, we noticed that there was no consistent trend between contribution amount and wins. For example, in NY democrats (NYD), Kathleen Hochul received the greatest amount in donations yet did not win. Similarly, Brian Higgins received few donations and won. Similarly, for NY republicans (NYR), Buerkle and Hayworth got the greatest amount in contribution yet lost. Thus, there seems to be no obvious direct correlation between amount of donations received and probability of winning.

Therefore, we decided to further our analysis by faceting the graphs by whether the candidate was an incumbent or not. It appears that if you are an incumbent, you are more likely to get larger donations (see CARplot2, TXRplot2, NYR/Dplot2), but not necessarily win. Similarly, if you are an incumbent, you are likely to win even if you have a smaller amount in contributions (see NYDplot2, CADplot2). 

Conclusion
From this data, we learn that if you are an incumbent, the amount of donations you receive does not necessarily have a significant impact on whether you win or not, however, if you are not an incumbent, donations matter more in determining whether or not you win. 

